<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스마트스토어 - 재고 관리</title>
    <link th:href="@{/css/store.css}" rel="stylesheet" />
</head>
<body>
<!-- 헤더 삽입 -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- 재고 관리 -->
<section class="seller-inventory-section">
    <div class="container">
        <!-- 페이지 타이틀 -->
        <div class="page-header">
            <h2 class="page-title">재고 관리</h2>
            <p class="page-description">상품의 재고를 효율적으로 관리하세요</p>
        </div>

        <!-- 검색 & 필터 -->
        <div class="inventory-toolbar">
            <div class="search-box">
                <input type="text" id="search-product" placeholder="상품명 또는 상품번호로 검색" />
                <button class="btn btn-search">검색</button>
            </div>

            <div class="filter-options">
                <select id="category-filter">
                    <option value="">전체 카테고리</option>
                    <option value="fashion">패션·의류</option>
                    <option value="beauty">뷰티·미용</option>
                    <option value="food">식품·건강</option>
                    <option value="digital">디지털·가전</option>
                    <option value="sports">스포츠·레저</option>
                    <option value="home">홈·리빙</option>
                </select>

                <select id="stock-filter">
                    <option value="">전체</option>
                    <option value="in-stock">재고 있음</option>
                    <option value="low-stock">재고 부족</option>
                    <option value="out-of-stock">품절</option>
                </select>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="location.href='/seller/products/new'">+ 상품 추가</button>
            </div>
        </div>

        <!-- 재고 통계 -->
        <div class="inventory-stats">
            <div class="stat-box">
                <span class="stat-label">전체 상품</span>
                <span class="stat-number" th:text="${totalProducts ?: 0}">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">재고 있음</span>
                <span class="stat-number" th:text="${inStockProducts ?: 0}">0</span>
            </div>
            <div class="stat-box warning">
                <span class="stat-label">재고 부족</span>
                <span class="stat-number" th:text="${lowStockProducts ?: 0}">0</span>
            </div>
            <div class="stat-box danger">
                <span class="stat-label">품절</span>
                <span class="stat-number" th:text="${outOfStockProducts ?: 0}">0</span>
            </div>
        </div>

        <!-- 재고 테이블 -->
        <div class="inventory-table-wrapper">
            <table class="inventory-table">
                <thead>
                <tr>
                    <th width="50"><input type="checkbox" id="select-all" /></th>
                    <th width="80">이미지</th>
                    <th>상품명</th>
                    <th width="100">카테고리</th>
                    <th width="100">판매가</th>
                    <th width="100">현재 재고</th>
                    <th width="100">상태</th>
                    <th width="150">작업</th>
                </tr>
                </thead>

                <tbody>
                <tr class="product-row"
                    th:each="p : ${products}"
                    th:attr="data-option-id=${p.optionId}">
                    <td>
                        <input type="checkbox" class="product-check" th:value="${p.optionId}">
                    </td>

                    <td>
                        <img class="product-thumb" th:src="@{${p.imageUrl}}" th:alt="${p.name}" />
                    </td>

                    <td class="product-name-cell">
                        <div class="product-name" th:text="${p.name}">상품명</div>
                        <div class="product-id"   th:text="'ID: ' + ${p.productId}">ID: 0</div>
                    </td>

                    <td th:text="${p.category}">카테고리</td>

                    <td class="price"
                        th:text="${#numbers.formatInteger(p.salePrice, 0, 'COMMA')} + '원'">0원</td>

                    <td>
                        <div class="stock-input-group">
                            <input class="stock-qty" type="number" th:value="${p.stockQty}">
                        </div>
                    </td>

                    <td>
                      <span class="status-badge"
                            th:classappend="${p.soldOut} ? 'out-of-stock' : (${p.low} ? 'low-stock' : 'in-stock')"
                            th:text="${p.soldOut} ? '품절' : (${p.low} ? '부족' : '재고 있음')">재고 있음</span>
                    </td>

                    <td>
                        <div class="action-buttons">
                            <button class="btn-action save"
                                    th:attr="onclick=|updateProductStock(${p.optionId})|">저장</button>
                            <button class="btn-action edit"
                                    th:attr="onclick=|location.href='/seller/products/${p.productId}/edit'|">수정</button>
                        </div>
                    </td>
                </tr>

                <!-- 비었을 때 -->
                <tr class="empty-row" th:if="${products == null or products.isEmpty()}">
                    <td colspan="8" class="empty-message">
                        <p>등록된 상품이 없습니다</p>
                        <a href="/seller/products/new" class="btn btn-primary">상품 등록하기</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- 일괄 작업 -->
        <div class="bulk-actions" th:if="${products != null and !products.isEmpty()}">
            <div class="action-info">
                <span id="selected-count">0</span>개 상품 선택됨
            </div>
            <div class="bulk-buttons">
                <button class="btn btn-secondary" onclick="bulkDelete()">선택 삭제</button>
                <button class="btn btn-secondary" onclick="bulkUpdateStock()">재고 일괄 변경</button>
            </div>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination" th:if="${totalPages > 1}">
            <a class="page-btn"
               th:href="@{/seller/inventory(page=${currentPage - 1})}"
               th:classappend="${currentPage == 1} ? 'disabled' : ''">이전</a>

            <a class="page-number"
               th:each="page : ${#numbers.sequence(1, totalPages)}"
               th:href="@{/seller/inventory(page=${page})}"
               th:classappend="${page == currentPage} ? 'active' : ''"
               th:text="${page}">1</a>

            <a class="page-btn"
               th:href="@{/seller/inventory(page=${currentPage + 1})}"
               th:classappend="${currentPage == totalPages} ? 'disabled' : ''">다음</a>
        </div>
    </div>
</section>

<!-- 푸터 삽입 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    // 전체 선택/해제
    document.getElementById('select-all').addEventListener('change', function() {
        document.querySelectorAll('.product-check').forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });

    // 개별 체크박스
    document.querySelectorAll('.product-check').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    // 선택된 상품 수 업데이트
    function updateSelectedCount() {
        const count = document.querySelectorAll('.product-check:checked').length;
        document.getElementById('selected-count').textContent = count;
    }

    // 개별 재고 업데이트
    function updateProductStock(optionId) {
        const row = document.querySelector(`.product-row[data-option-id="${optionId}"]`);
        if (!row) { alert('행을 찾을 수 없습니다.'); return; }

        const stockQty = parseInt(row.querySelector('.stock-qty').value, 10) || 0;

        if (confirm(`재고를 ${stockQty}개로 변경하시겠습니까?`)) {
            fetch(`/api/v1/seller/inventory/${optionId}/set-qty`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ qty: stockQty, reason: '직접 수정' })
            })
                .then(res => {
                    if (!res.ok) throw new Error();
                    alert('재고가 업데이트되었습니다.');
                    location.reload();
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('요청 중 오류가 발생했습니다.');
                });
        }
    }

    // 일괄 삭제
    function bulkDelete() {
        const checked = document.querySelectorAll('.product-check:checked');
        if (checked.length === 0) {
            alert('선택한 상품이 없습니다.');
            return;
        }

        if (confirm(`선택한 ${checked.length}개 상품을 삭제하시겠습니까?`)) {
            const productIds = Array.from(checked).map(cb => cb.value);

            fetch(`/seller/products/bulk-delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ productIds: productIds })
            })
                .then(response => {
                    if (response.ok) {
                        alert('상품이 삭제되었습니다.');
                        location.reload();
                    } else {
                        alert('오류가 발생했습니다.');
                    }
                })
                .catch(error => {
                    alert('요청 중 오류가 발생했습니다.');
                    console.error('Error:', error);
                });
        }
    }


    // 일괄 재고 변경
    function bulkUpdateStock() {
        const checked = document.querySelectorAll('.product-check:checked');
        if (checked.length === 0) {
            alert('선택한 상품이 없습니다.');
            return;
        }

        const quantity = prompt(`${checked.length}개 상품의 재고를 입력해주세요:`, '0');
        if (quantity !== null && quantity !== '') {
            const productIds = Array.from(checked).map(cb => cb.value);

            fetch(`/seller/products/bulk-update-stock`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    productIds: productIds,
                    stockQty: parseInt(quantity)
                })
            })
                .then(response => {
                    if (response.ok) {
                        alert('재고가 일괄 업데이트되었습니다.');
                        location.reload();
                    } else {
                        alert('오류가 발생했습니다.');
                    }
                })
                .catch(error => {
                    alert('요청 중 오류가 발생했습니다.');
                    console.error('Error:', error);
                });
        }
    }


    // 검색 기능
    document.querySelector('.btn-search').addEventListener('click', function() {
        const keyword = document.getElementById('search-product').value;
        const category = document.getElementById('category-filter').value;
        const stock = document.getElementById('stock-filter').value;

        let url = '/seller/inventory?';

        if (keyword) {
            url += 'search=' + encodeURIComponent(keyword) + '&';
        }
        if (category) {
            url += 'category=' + category + '&';
        }
        if (stock) {
            url += 'stock=' + stock;
        }

        window.location.href = url;
    });

</script>
</body>
</html>
